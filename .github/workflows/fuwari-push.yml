name: Fuwari-Push
on:
  schedule:
    - cron: '0 22 * * *'  # 北京时间早6点（UTC+8，对应UTC前一天22点）
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取私有源仓库
        run: |
          git clone --depth 1 https://${{ secrets.GH_PAT }}@github.com/yCENzh/fuwari.git
          cd fuwari

      - name: 清理 posts 文件夹（仅保留 Default）
        run: |
          cd fuwari
          find src/content/posts -mindepth 1 -maxdepth 1 ! -name "Default" -exec rm -rf {} +

      - name: 获取源仓库最后提交信息
        id: commit
        run: |
          cd fuwari
          echo "HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "MSG=$(git log -1 --format=%s | tr ' ' '-')" >> $GITHUB_ENV

      - name: 推送至公开目标仓库
        run: |
          cd fuwari
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add .
          git commit -m "commit-${{ env.MSG }}-${{ env.HASH }}"
          git remote add target https://${{ secrets.GH_PAT }}@github.com/yCENzh/Fuwari-yCENzh.git
          git push -f target main  # 目标分支非main可替换
