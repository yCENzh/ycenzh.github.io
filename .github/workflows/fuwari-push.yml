name: Fuwari-Push
on:
  schedule:
    - cron: '0 22 * * *'  # 北京时间早6点（UTC+8对应UTC前一天22点）
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取目标仓库（Fuwari-yCENzh）
        run: |
          git clone https://${{ secrets.GH_PAT }}@github.com/yCENzh/Fuwari-yCENzh.git target-repo
          cd target-repo

      - name: 拉取私有源仓库（fuwari）
        run: |
          git clone --depth 1 https://${{ secrets.GH_PAT }}@github.com/yCENzh/fuwari.git source-repo
          cd source-repo

      - name: 用源仓库文件全覆盖目标仓库（保留目标仓库.git目录）
        run: |
          # 复制源仓库所有文件（含隐藏文件）到目标仓库，强制覆盖
          cp -rf source-repo/* target-repo/
          cp -rf source-repo/.* target-repo/  # 覆盖隐藏文件（如.gitignore）

      - name: 清理 posts 文件夹（仅保留 Default）
        run: |
          cd target-repo
          if [ -d "src/content/posts" ]; then
            find src/content/posts -mindepth 1 -maxdepth 1 ! -name "Default" -exec rm -rf {} +
          else
            echo "src/content/posts 目录不存在，跳过清理"
          fi

      - name: 获取源仓库最后提交信息
        id: commit
        run: |
          cd source-repo
          echo "HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "MSG=$(git log -1 --format=%s | tr ' ' '-')" >> $GITHUB_ENV

      - name: 提交并推送到目标仓库
        run: |
          cd target-repo
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add .  # 暂存所有覆盖和清理后的文件
          git commit -m "commit-${{ env.MSG }}-${{ env.HASH }}" || echo "无文件变更，跳过提交"
          git push origin main  # 目标分支非main可替换
